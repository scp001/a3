/*! splat 2015-11-26 */
"use strict";var splat=splat||{};splat.Review=Backbone.Model.extend({idAttribute:"_id",initialize:function(){this.validators={},this.validators.reviewname=function(a){return a&&a.length>0?{isValid:!0}:{isValid:!1,message:"reviewer's name required"}},this.validators.reviewaffil=function(a){return a&&a.length>0?{isValid:!0}:{isValid:!1,message:"reviewer's affiliation required"}},this.validators.reviewtext=function(a){return a&&a.length>0?{isValid:!0}:{isValid:!1,message:"You must enter some review text"}}},validateItem:function(a){return this.validators[a]?this.validators[a](this.get(a)):{isValid:!0}},validateAll:function(){var a={};for(var b in this.validators)if(this.validators.hasOwnProperty(b)){var c=this.validators[b](this.get(b));c.isValid===!1&&(a[b]=c.message)}return _.size(a)>0?{isValid:!1,messages:a}:{isValid:!0}},defaults:{freshness:1,reviewtext:"",reviewname:"",reviewaffil:"",movieid:null}});var splat=splat||{};splat.Movie=Backbone.Model.extend({idAttribute:"_id",initialize:function(){this.reviews=new splat.Reviews,this.reviews.url="/movies/"+this.id+"/reviews",this.validators={};var a=/^([\ \,\.\?\-\'\*]*[a-zA-Z0-9]+[\ \,\.\?\-\'\*]*)+$/,b=/^(19[1-9]\d)|(200\d)|(201[0-6])$/,c=/^([\w\-\']+(\s[\w\-\']+)*)(,[\w\-\']+(\s[\w\-\']+)*)*$/,d=/^G|(PG)|(PG-13)|R|(NC-17)|(NR)$/,e=/^(\d)|(\d\d)|\d{3}$/,f=/^\w+(\s+\w+)*$/,g=/^(https?:\/\/\w+(\.\w+)*(:\d+)?(\/[\w\.#]+)*\/?)?$/;this.validators.title=function(b){return b&&a.test(b)?{isValid:!0}:{isValid:!1,message:'Must be: one or more letters-digits-spaces with one or more of " ,.?-\'*" '}},this.validators.released=function(a){return a&&b.test(a)?{isValid:!0}:{isValid:!1,message:"Release Date must be from 1910 to 2016 inclusive"}},this.validators.director=function(b){return b&&a.test(b)?{isValid:!0}:{isValid:!1,message:'Must be: one or more letters-digits-spaces with one or more of " ,.?-\'*" '}},this.validators.rating=function(a){return a&&d.test(a)?{isValid:!0}:{isValid:!1,message:"You must enter a valid MPAA rating, e.g. PG"}},this.validators.starring=function(a){return a&&c.test(a)?{isValid:!0}:{isValid:!1,message:"At least one star must be listed"}},this.validators.duration=function(a){return a&&e.test(a)?{isValid:!0}:{isValid:!1,message:"Duration must be in the range 0 to 999"}},this.validators.genre=function(a){return a&&c.test(a)?{isValid:!0}:{isValid:!1,message:"You must enter at least one genre"}},this.validators.synopsis=function(a){return a&&f.test(a)?{isValid:!0}:{isValid:!1,message:"Synopsis must consist of a non-empty word list"}},this.validators.trailer=function(a){return""===a||g.test(a)?{isValid:!0}:{isValid:!1,message:"Trailer must be empty or a valid URL"}}},validateItem:function(a){return this.validators[a]?this.validators[a](this.get(a)):{isValid:!0}},validateAll:function(){var a={};for(var b in this.validators)if(this.validators.hasOwnProperty(b)){var c=this.validators[b](this.get(b));c.isValid===!1&&(a[b]=c.message)}return _.size(a)>0?{isValid:!1,messages:a}:{isValid:!0}},defaults:{title:"",released:null,director:"",starring:[],rating:"",duration:null,genre:"",synopsis:"",freshTotal:0,freshVotes:0,trailer:"",poster:"img/placeholder.png",dated:new Date}});var splat=splat||{};splat.User=Backbone.Model.extend({urlRoot:"/user",idAttribute:"_id",initialize:function(){this.validators={},this.validators.username=function(a){return a&&a.length>0?{isValid:!0}:{isValid:!1,message:"username required"}},this.validators.email=function(a){return a&&a.length>0?{isValid:!0}:{isValid:!1,message:"email required"}},this.validators.password=function(a){return a&&a.length>0?{isValid:!0}:{isValid:!1,message:"password required"}},this.validators.password2=function(a){return a&&a.length>0?{isValid:!0}:{isValid:!1,message:"password required"}}},validateItem:function(a){return this.validators[a]?this.validators[a](this.get(a)):{isValid:!0}},validateAll:function(){var a={};for(var b in this.validators)if(this.validators.hasOwnProperty(b)){var c=this.validators[b](this.get(b));c.isValid===!1&&(a[b]=c.message)}return _.size(a)>0?{isValid:!1,messages:a}:{isValid:!0}}});var splat=splat||{};splat.Users=Backbone.Collection.extend({model:splat.User,url:"/user"});var splat=splat||{};splat.Movies=Backbone.Collection.extend({model:splat.Movie,url:"/movies"});var splat=splat||{};splat.Reviews=Backbone.Collection.extend({model:splat.Review,url:"/movies/:id/reviews"});var splat=splat||{};splat.About=Backbone.View.extend({initialize:function(){this.render()},render:function(){return this.$el.html(this.template()),this}});var splat=splat||{};splat.Details=Backbone.View.extend({events:{"click #moviesave":"beforeSave","click #moviedel":"deleteMovie"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.formView=new splat.MovieForm({model:this.model}),this.$("#movieform").append(this.formView.render().el),this.imgView=new splat.MovieImg({model:this.model}),this.$("#movieimg").append(this.imgView.render().el),this},beforeSave:function(){this.formView.beforeSave()},deleteMovie:function(){this.formView.deleteMovie()},onClose:function(){this.formView&&this.formView.remove(),this.imgView&&this.imgView.remove()}});var splat=splat||{};splat.Header=Backbone.View.extend({initialize:function(){this.listenTo(Backbone,"signedUp",this.signedUp),this.listenTo(Backbone,"signedIn",this.signedIn),this.listenTo(Backbone,"signedOut",this.signedOut)},events:{"change input[name=sortOrder]":"sortOrder"},render:function(){this.$el.html(this.template());var a=new splat.User;return this.signupform=new splat.Signup({model:a}),this.$("#signupDiv").append(this.signupform.render().el),this.signinform=new splat.Signin({model:a}),this.$("#signinDiv").append(this.signinform.render().el),this},authenticatedUI:function(a){$("#greet").html(a.username),$("#signoutUser").html("<b>"+a.username+"</b>"),$(".btn.signinSubmit").css("display","none"),$(".btn.signoutSubmit").css("display","block"),$("#addMovie").show()},signedUp:function(a){$("#signupdrop").removeClass("open"),$(".signinput").css("display","none"),$("#signupForm")[0].reset(),this.authenticatedUI(a)},signedIn:function(a){$("#signindrop").removeClass("open"),$('[class*="signin"]').css("display","none"),$("#signinForm")[0].reset(),this.authenticatedUI(a)},signedOut:function(a){$("#greet").html("Sign In"),$("#signoutUser").html(""),$(".btn.signoutSubmit").css("display","none"),$(".btn.signinSubmit").css("display","block"),$('[class*="signin"]').css("display","block"),$("#signindrop").removeClass("open"),$("#addMovie").hide()},sortOrder:function(a){a.stopPropagation(),splat.order=a.target.value,Backbone.trigger("orderevent",a),$("#orderdrop").removeClass("open")},selectMenuItem:function(a){$(".nav li").removeClass("active"),a&&$("."+a).addClass("active")}});var splat=splat||{};splat.Home=Backbone.View.extend({render:function(){return this.$el.html(this.template()),this}});var splat=splat||{};splat.MovieThumb=Backbone.View.extend({});var splat=splat||{};splat.MovieForm=Backbone.View.extend({events:{"change .authattr":"change"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},deleteMovie:function(a){return this.model.destroy({data:JSON.stringify({userid:this.model.get("userid")}),contentType:"application/json",wait:!0,success:function(a,b){splat.app.navigate("/movies",{replace:!0,trigger:!0}),splat.utils.showAlert("Success","Movie deleted","alert-success")},error:function(a,b){splat.utils.requestFailed(b)}}),!1},change:function(a){splat.utils.hideAlert();var b={};if(b[a.target.name]=_.escape(a.target.value),"starring"===a.target.name||"genre"===a.target.name){var c=a.target.value.split(",");b[a.target.name]=c}this.model.set(b);var d=this.model.validateItem(a.target.name);d.isValid?splat.utils.removeValidationError(a.target.name):splat.utils.addValidationError(a.target.name,d.message),splat.utils.showAlert("Note!",'Movie attribute updated; to make changes permanent, click "Save Changes" button',"alert-info")},beforeSave:function(){var a=this,b=a.model.validateAll();return b.isValid===!1?(splat.utils.displayValidationErrors(b.messages),!1):void this.saveMovie()},saveMovie:function(){var a=this.model.isNew();this.model.collection.create(this.model,{wait:!0,success:function(b,c){a&&(splat.app.navigate("movies/"+b.get("_id"),{trigger:!0,replace:!0}),b.reviews.url="/movies/"+b.get("_id")+"/reviews"),splat.utils.showAlert("Success!","Movie saved","alert-success")},error:function(a,b){splat.utils.requestFailed(b)}})}});var splat=splat||{};splat.MoviesView=Backbone.View.extend({initialize:function(a){this.listenTo(Backbone,"orderevent",this.render)},moviesTemplate:_.template(["<% movies.each(function(movie) { %>","<%= movieTemplate(movie.toJSON()) %>","<% }); %>"].join("")),render:function(){this.movieTemplate=new splat.MovieThumb,this.collection.comparator=function(a){return a.get(splat.order).toLowerCase()},this.collection.sort();var a=this.moviesTemplate({movies:this.collection,movieTemplate:this.movieTemplate.template});return $(this.el).html(a),this},onClose:function(){this.remove()}});var splat=splat||{};splat.Reviewer=Backbone.View.extend({initialize:function(a){this.model.bind("destroy",this.close,this),this.reviews=this.collection,this.model.collection=this.collection},events:{"change .reviewform":"change","click #reviewsave":"saveReview"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},change:function(a){splat.utils.hideAlert();var b={};b[a.target.name]=_.escape(a.target.value),this.model.set(b)},saveReview:function(a){var b=this;b.reviews.create(b.model,{wait:!0,success:function(a,c){b.model=new splat.Review,b.model.collection=b.reviews,b.render(),splat.utils.showAlert("Success!","Review saved","alert-success")},error:function(a,b){splat.utils.showAlert("Error",b.responseText,"alert-danger")}})}});var splat=splat||{};splat.ReviewsView=Backbone.View.extend({initialize:function(){this.review||(this.review=new splat.Review,this.review.set("movieid",this.model.get("_id"))),this.reviews=this.collection,this.listenTo(this.reviews,"sync",this.showScore),this.listenTo(this.reviews,"sync",this.renderReviews)},render:function(){return this.renderContent().renderReviewer().renderReviews().showScore(),this},renderContent:function(){return this.$el.html(this.template()),this},renderReviewer:function(){return this.reviewerview&&this.reviewerview.remove(),this.reviewerview=new splat.Reviewer({model:this.review,collection:this.collection}),this.$("#myreview").append(this.reviewerview.render().el),this},renderReviews:function(){return this.reviewthumbs&&this.reviewthumbs.remove(),this.reviewthumbs=new splat.ReviewThumbs({collection:this.collection}),this.$("#reviews").html(this.reviewthumbs.render().el),this},showScore:function(){var a=this;this.model.fetch({success:function(b,c){a.collection.length>0?$.get("tpl/Score.html",function(b){var c=_.template(b);a.$("#scoreView").html(c(a.model.toJSON()))}):a.$("#scoreCount").html("<span>... no reviews yet</span>")},error:function(a,b){splat.utils.requestFailed(b)}})},onClose:function(){this.reviewerview&&this.reviewerview.remove(),this.reviewthumbs&&this.reviewthumbs.remove(),this.scoreview&&this.scoreview.remove()}});var splat=splat||{};splat.Signin=Backbone.View.extend({el:'<form id="signinForm" accept-charset="UTF-8">',events:{"change .signinput":"change","click .signinSubmit":"signin","click .signoutSubmit":"signout"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},change:function(a){splat.utils.hideAlert(),this.model||(this.model=new splat.User);var b={};b[a.target.name]=_.escape(a.target.value),this.model.set(b);var c=this.model.validateItem(a.target.name);c.isValid?splat.utils.removeValidationError(a.target.name):splat.utils.addValidationError(a.target.name,c.message)},signin:function(a){a.preventDefault();var b=this,c=b.model.validateItem("username");c.isValid?splat.utils.removeValidationError("username"):splat.utils.addValidationError("username",c.message);var d=b.model.validateItem("password");return d.isValid?splat.utils.removeValidationError("password"):splat.utils.addValidationError("password",d.message),c.isValid&&d.isValid?(this.model.set({login:1}),void this.model.save(null,{type:"put",wait:!0,success:function(a,b){b.error?splat.utils.showAlert("Signin Failed",b.error,"alert-danger"):(splat.token=b.token,splat.userid=b.userid,splat.username=b.username,splat.utils.showAlert("Signin Successful!","Welcome back "+splat.username,"alert-success"),Backbone.trigger("signedIn",b))},error:function(a,b){splat.utils.showAlert("Error",b.responseText,"alert-danger")}})):!1},signout:function(a){a.preventDefault(),$("#logoutdrop").removeClass("open"),this.model.set({login:0,username:"",password:""}),this.model.save(null,{type:"put",success:function(a,b){splat.token=b.token,splat.utils.showAlert("Signout Successful!","Please Come Back Soon","alert-success"),Backbone.trigger("signedOut",b)},error:function(a){splat.utils.showAlert("Error",a.responseText,"alert-danger")}})}});var splat=splat||{};splat.Signup=Backbone.View.extend({el:'<form id="signupForm" accept-charset="UTF-8">',events:{"change .signup":"change","click .signupSubmit":"signup"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},change:function(a){var b=this;splat.utils.hideAlert(),this.model||(this.model=new splat.User);var c={};c[a.target.name]=_.escape(a.target.value),this.model.set(c);var d;"password"===a.target.name||"password2"===a.target.name?b.$("#signup_password").val()!==b.$("#signup_password2").val()?d={isValid:!1,message:"Password values must match"}:(d=this.model.validateItem(a.target.name),splat.utils.removeValidationError("password"),splat.utils.removeValidationError("password2")):d=this.model.validateItem(a.target.name),d.isValid?splat.utils.removeValidationError(a.target.name):splat.utils.addValidationError(a.target.name,d.message)},signup:function(a){a.preventDefault();var b=this,c=b.model.validateAll();return c.isValid===!1?(splat.utils.displayValidationErrors(c.messages),!1):void this.model.save(null,{wait:!0,success:function(a,b){b.error?splat.utils.showAlert("Signup Failed","Failed to create account","alert-danger"):(splat.token=b.token,splat.userid=b.userid,splat.username=b.username,splat.utils.showAlert("Signup Successful!","Welcome "+splat.username,"alert-success"),Backbone.trigger("signedUp",b))},error:function(a,b){splat.utils.showAlert("Error",b.responseText,"alert-danger")}})}});var splat=splat||{};splat.AppRouter=Backbone.Router.extend({routes:{"":"home",about:"about",movies:"browse","movies/add":"addMovie","movies/:id":"editMovie","movies/:id/reviews":"reviewMovie","*default":"defaultRoute"},defaultRoute:function(){this.home()},initialize:function(){splat.order="title",this.movies=new splat.Movies,this.moviesLoaded=this.movies.fetch(),this.headerView=new splat.Header,$(".header").html(this.headerView.render().el)},home:function(){this.homeView||(this.homeView=new splat.Home),splat.app.showView("#content",this.homeView),this.headerView.selectMenuItem("home-menu")},about:function(){this.aboutView||(this.aboutView=new splat.About),splat.app.showView("#content",this.aboutView),this.headerView.selectMenuItem("about-menu")},browse:function(){var a=this;this.moviesBrowse=this.movies.fetch(),this.moviesBrowse.done(function(){splat.moviesView=new splat.MoviesView({collection:a.movies}),splat.app.showView("#content",splat.moviesView)}),this.headerView.selectMenuItem("browse-menu")},editMovie:function(a){var b=this;this.editFetch=this.movies.fetch(),this.editFetch.done(function(){b.movieView(a)}),this.headerView.selectMenuItem()},movieView:function(a){var b=this.movies.get(a);if(b){var c=new splat.Details({model:b});splat.app.showView("#content",c)}else splat.utils.showAlert("Error","can't find this movie (perhaps deleted?)","alert-danger")},addMovie:function(){var a=new splat.Movie;a.collection=this.movies,this.moviesLoaded.done(function(){var b=new splat.Details({model:a});splat.app.showView("#content",b)}),this.headerView.selectMenuItem("add-menu")},reviewMovie:function(a){var b=this;this.moviesLoaded.done(function(){if(a){var c=b.movies.get(a);c.reviews.fetch({silent:!0,success:function(a,d){b.reviewsView=new splat.ReviewsView({model:c,collection:a}),splat.app.showView("#content",b.reviewsView)}})}else b.$("#reviews").html("<h3>No Reviews Yet</h3>")})},showView:function(a,b){return this.currentView&&this.currentView.close(),$(a).html(b.render().el),this.currentView}}),Backbone.View.prototype.close=function(){this.onClose&&this.onClose(),this.remove(),this.unbind()},Backbone.ajax=function(){return Backbone.$.ajaxSetup.call(Backbone.$,{beforeSend:function(a){a.setRequestHeader("X-CSRF-Token",splat.csrftoken)}}),Backbone.$.ajax.apply(Backbone.$,arguments)},splat.utils.loadTemplates(["Home","Header","About","MovieThumb","Details","MovieForm","MovieImg","Reviewer","ReviewsView","Signup","Signin"],function(){splat.app=new splat.AppRouter,Backbone.history.start()});var splat=splat||{};splat.utils={loadTemplates:function(a,b){var c=[];$.each(a,function(a,b){splat[b]?c.push($.get("tpl/"+b+".html",function(a){splat[b].prototype.template=_.template(a)})):alert(b+" not found")}),$.when.apply(null,c).done(b)},displayValidationErrors:function(a){for(var b in a)a.hasOwnProperty(b)&&this.addValidationError(b,a[b]);this.showAlert("Error!","Fix validation errors and try again","alert-danger")},addValidationError:function(a,b){if("synopsis"===a)var c=$("textarea").parent();else var c=$("input[name='"+a+"']").parent();c.addClass("has-error"),$(".help-block",c).html(b)},removeValidationError:function(a){if("synopsis"===a)var b=$("textarea").parent();else var b=$("input[name='"+a+"']").parent();b.removeClass("has-error"),$(".help-block",b).html("")},showAlert:function(a,b,c){$(".alert").removeClass("alert-danger alert-warning alert-success alert-info"),$(".alert").addClass(c),$(".alert").html("<strong>"+a+"</strong> "+b),$(".alert").stop(!0,!0).show().fadeOut(5e3)},hideAlert:function(){$(".alert").stop(!0,!0).hide()},requestFailed:function(a){a.responseText.indexOf('"status":403')>-1?(splat.utils.showAlert("Error","Please Sign-In to complete this action","alert-danger"),$("#greet").html("Sign In"),$("#logoutUser").html(""),$(".btn.logout").css("display","none"),$(".btn.login").css("display","block"),$('[class*="signin"]').css("display","block"),$("#logindrop").removeClass("open"),$("#addMovie").hide()):splat.utils.showAlert("Error",a.responseText,"alert-danger")},uploadFile:function(a,b,c,d){var e=this,f=new FormData;f.append("file",c),f.append("userid",b),$.ajax({url:"/movies/"+a+"/image",type:"POST",data:f,processData:!1,cache:!1,contentType:!1}).done(function(a){d(a)}).fail(function(a){e.showAlert("Error!",a.responseText,"alert-danger")})}};